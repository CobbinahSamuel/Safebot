<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMaT Student Verification - SAFEBOT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
</head>
<body class="bg-gradient-to-br from-green-50 via-white to-green-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <span class="text-3xl">üõ°Ô∏è</span>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">UMaT Student Verification</h1>
            <p class="text-gray-600">University of Mines and Technology</p>
            <p class="text-sm text-gray-500 mt-2">Verify your student status to access SAFEBOT</p>
        </div>

        <!-- Main Card -->
        <div class="max-w-md mx-auto">
            <div class="bg-white/80 backdrop-blur-sm border border-gray-200/50 shadow-xl rounded-2xl p-8">
                
                <!-- Loading State -->
                <div id="loading" class="text-center hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                    <p class="text-gray-600">Verifying your credentials...</p>
                </div>

                <!-- Verification Form -->
                <div id="verificationForm">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Student Verification</h2>
                        <p class="text-gray-600 text-sm">Please provide your UMaT student details</p>
                    </div>

                    <!-- Alert Messages -->
                    <div id="errorAlert" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-red-500 mr-2">‚ö†Ô∏è</span>
                            <span id="errorMessage" class="text-red-700 text-sm"></span>
                        </div>
                    </div>

                    <form id="studentForm" class="space-y-4">
                        <!-- Full Name -->
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">
                                Full Name (as registered)
                            </label>
                            <input 
                                type="text" 
                                id="fullName" 
                                name="fullName"
                                required
                                placeholder="Enter your full name"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                            />
                        </div>

                        <!-- Index Number -->
                        <div>
                            <label for="indexNumber" class="block text-sm font-medium text-gray-700 mb-1">
                                Student Index Number
                            </label>
                            <input 
                                type="text" 
                                id="indexNumber" 
                                name="indexNumber"
                                required
                                placeholder="e.g., BCS/21/001"
                                pattern="^[A-Z]{2,4}\/\d{2}\/\d{3}$"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors uppercase"
                            />
                            <p class="text-xs text-gray-500 mt-1">Format: Department/Year/Number</p>
                        </div>

                        <!-- Submit Button -->
                        <button 
                            type="submit" 
                            id="verifyBtn"
                            class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-4 rounded-lg font-semibold transition-all duration-300 transform hover:scale-[1.02] focus:ring-4 focus:ring-green-500/25"
                        >
                            <span class="flex items-center justify-center">
                                <span class="mr-2">üîç</span>
                                Verify Student Status
                            </span>
                        </button>
                    </form>
                </div>

                <!-- Success State -->
                <div id="successState" class="hidden text-center">
                    <div class="mb-6">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl">‚úÖ</span>
                        </div>
                        <h2 class="text-2xl font-bold text-green-700 mb-2">Verification Successful!</h2>
                        <p class="text-gray-600" id="welcomeMessage">Welcome to SAFEBOT</p>
                    </div>
                    
                    <button 
                        id="returnToTelegram"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold transition-all duration-300"
                    >
                        <span class="flex items-center justify-center">
                            <span class="mr-2">üì±</span>
                            Return to Telegram
                        </span>
                    </button>
                </div>

                <!-- Footer -->
                <div class="mt-8 pt-4 border-t border-gray-200 text-center">
                    <p class="text-xs text-gray-500">
                        Secure verification powered by UMaT-SRID
                    </p>
                </div>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="max-w-2xl mx-auto mt-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white/60 backdrop-blur-sm border border-gray-200/50 rounded-xl p-4">
                    <div class="flex items-center mb-2">
                        <span class="text-xl mr-2">üîí</span>
                        <h3 class="font-semibold text-gray-900">Secure Verification</h3>
                    </div>
                    <p class="text-sm text-gray-600">Your information is encrypted and verified against official UMaT records.</p>
                </div>
                
                <div class="bg-white/60 backdrop-blur-sm border border-gray-200/50 rounded-xl p-4">
                    <div class="flex items-center mb-2">
                        <span class="text-xl mr-2">‚ö°</span>
                        <h3 class="font-semibold text-gray-900">Quick Process</h3>
                    </div>
                    <p class="text-sm text-gray-600">Verification typically takes just a few seconds to complete.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chat_id');
        const sessionToken = urlParams.get('session');
        
        // API Configuration
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // DOM Elements
        const form = document.getElementById('studentForm');
        const loadingState = document.getElementById('loading');
        const verificationForm = document.getElementById('verificationForm');
        const successState = document.getElementById('successState');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const verifyBtn = document.getElementById('verifyBtn');
        const returnToTelegramBtn = document.getElementById('returnToTelegram');
        const welcomeMessage = document.getElementById('welcomeMessage');
        
        // Auto-format index number
        document.getElementById('indexNumber').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
        
        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
        }
        
        // Hide error message
        function hideError() {
            errorAlert.classList.add('hidden');
        }
        
        // Show loading state
        function showLoading() {
            verificationForm.classList.add('hidden');
            loadingState.classList.remove('hidden');
        }
        
        // Hide loading state
        function hideLoading() {
            loadingState.classList.add('hidden');
            verificationForm.classList.remove('hidden');
        }
        
        // Show success state
        function showSuccess(studentName) {
            verificationForm.classList.add('hidden');
            successState.classList.remove('hidden');
            welcomeMessage.textContent = `Welcome, ${studentName}! You are now verified to use SAFEBOT.`;
        }
        
        // Handle form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();
            showLoading();
            
            const formData = new FormData(form);
            const fullName = formData.get('fullName').trim();
            const indexNumber = formData.get('indexNumber').trim();
            
            try {
                // Validate input format
                const indexPattern = /^[A-Z]{2,4}\/\d{2}\/\d{3}$/;
                if (!indexPattern.test(indexNumber)) {
                    throw new Error('Please enter a valid index number format (e.g., BCS/21/001)');
                }
                
                if (fullName.length < 2) {
                    throw new Error('Please enter your full name');
                }
                
                // Call verification API
                const response = await axios.post(`${API_BASE_URL}/auth/verify-student`, {
                    fullName: fullName,
                    indexNumber: indexNumber,
                    chatId: chatId,
                    sessionToken: sessionToken
                });
                
                if (response.data.verified) {
                    showSuccess(response.data.studentName);
                    
                    // Store verification token for Telegram redirect
                    localStorage.setItem('verificationToken', response.data.verificationToken);
                } else {
                    throw new Error(response.data.message || 'Student verification failed');
                }
                
            } catch (error) {
                hideLoading();
                const errorMsg = error.response?.data?.message || error.message || 'Verification failed. Please try again.';
                showError(errorMsg);
            }
        });
        
        // Handle return to Telegram
        returnToTelegramBtn.addEventListener('click', function() {
            const verificationToken = localStorage.getItem('verificationToken');
            
            if (chatId && verificationToken) {
                // Redirect back to Telegram with verification token
                const telegramUrl = `https://t.me/UMaT_safebot?start=verified_${verificationToken}`;
                window.location.href = telegramUrl;
            } else {
                // Fallback to main bot
                window.location.href = 'https://t.me/UMaT_safebot';
            }
        });
        
        // Check if required parameters are present
        if (!chatId || !sessionToken) {
            showError('Invalid verification link. Please start from the Telegram bot.');
        }
    </script>
</body>
</html>
